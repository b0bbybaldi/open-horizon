#!/bin/bash

## change hostname
if [ -n "%%DEVICE_NAME%%" ] && [ "%%DEVICE_NAME%%" != 'null' ]; then
  if [ $(cat /etc/hostname) != "%%DEVICE_NAME%%" ]; then
    echo '%%DEVICE_NAME%%' > /etc/hostname
    sed -i 's|\(.*\)%%CLIENT_HOSTNAME%%|\1%%DEVICE_NAME%% %%CLIENT_HOSTNAME%%|' /etc/hosts
    hostname "%%DEVICE_NAME%%"
  fi
else
  echo "+++ WARN: $(date) -- no device name specified" >> ~/horizon.log 2>&1
fi

## install horizon
if [ -z $(command -v hzn) ]; then
  wget -qO - "%%HORIZON_SETUP_URL%%" | bash &> ~/horizon.log
fi

if [ $(hzn node list | jq '.id==null') != "true" ]; then
  echo "+++ WARN: $(date) -- horizon not configured" >> ~/horizon.log 2>&1
else
  echo "--- INFO: $(date) -- horizon configured:" $(hzn node list | jq -c '.') >> ~/horizon.log 2>&1
fi

## SSH
SSH=~%%CLIENT_USERNAME%%/.ssh
KEYS="${SSH}/authorized_keys"

if [ -s /ssh.pub ] && [ ! -s "${KEYS}" ]; then
  ## add authorized public key
  mkdir -p "${SSH}"
  mv /ssh.pub "${SSH}/authorized_keys"
  chmod 600 "${SSH}/authorized_keys"
  ## password
  if [ -z $(command -v expect) ]; then
    apt install -y expect &> apt.log
  fi
  # build expect script
  echo 'spawn passwd %%CLIENT_USERNAME%%' > passwd.exp
  echo 'for {} 1 {} { expect {' >> passwd.exp
  echo '  "Enter new UNIX password:" { send "%%DEVICE_TOKEN%%\r" }' >> passwd.exp
  echo '  "Retype new UNIX password:" { send "%%DEVICE_TOKEN%%\r" }' >> passwd.exp
  echo '  "password updated successfully" { send_user "changed" ; exit }}}' >> passwd.exp
  # change password
  RESULT=$(expect -f passwd.exp | egrep "changed")
  if [ "${RESULT}" != "changed" ]; then
    # report failure
    echo "failure"
  else
    # report success
    echo "${RESULT}"
    # change sshd rules
    echo 'ChallengeResponseAuthentication no' > sshd_config
    echo 'PasswordAuthentication no' >> sshd_config
    echo 'UsePAM no' >> sshd_config
    mv sshd_config /etc/ssh/sshd_config
    /etc/init.d/ssh restart &> /dev/null
  fi
elif [ ! -s "/ssh.pub" ]; then
  echo "+++ WARN: $(date) -- SSH already configured; removing /ssh.pub" >> ~/horizon.log 2>&1
  rm -f "/ssh.pub"
fi

exit 0
