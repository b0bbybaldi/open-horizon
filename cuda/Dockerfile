# from Ubuntu 16.04
FROM arm64v8/ubuntu:xenial-20190122 as jetsontx2-xenial-drivers

# Update packages, install some useful packages
RUN apt update && apt install -y \
	apt-utils \
	bzip2 \
	sudo \
	curl \
  && apt-get clean && rm -rf /var/cache/apt

###
### Linux for Tegra R28.2.1 - from https://developer.nvidia.com/embedded/linux-tegra-r2821
###

ARG DRIVER=https://developer.nvidia.com/embedded/dlc/tx2-driver-package-r2821
# ARG DRIVER=https://developer.download.nvidia.com/embedded/L4T/r28_Release_v2.1/Tegra186_Linux_R28.2.1_aarch64.tbz2?13qZ4v6KW-jZhShNacOKJuPQokXaJovAgsQDweNHk8WGu4th8Sz3K1mrnuh_Pkckrp6B0-HmmEpopd_dt-BliMjOMzA6U-jOdf5puStXvE_WrICmI66emlPmizA1XIGVobM8oUeektM8e_SCFJUH3KTU6-K62gY-yIEVoXM7jcM

# creates the Linux_for_Tegra/ directory 
RUN curl -sSL ${DRIVER} | tar xpfj - 
RUN ./Linux_for_Tegra/apply_binaries.sh -r /
RUN rm -fr ./Linux_for_Tegra

## Clean up (don't remove cuda libs... used by child containers)
RUN apt-get -y autoremove && apt-get -y autoclean
RUN rm -rf /var/cache/apt

###
### JETPACK 
###

FROM jetsontx2-xenial-drivers as jetsontx2-jetpack33

# from https://layers.openembedded.org/layerindex/recipe/87651/
ARG JETPACK_URL=https://developer.download.nvidia.com/devzone/devcenter/mobile/jetpack_l4t/3.3/lw.xd42/JetPackL4T_33_b39

# retrieve all packages in JetPack
RUN for DEB in \
	cuda-repo-l4t-9-0-local_9.0.252-1_arm64.deb \
	libcudnn7_7.1.5.14-1+cuda9.0_arm64.deb \
	libcudnn7-dev_7.1.5.14-1+cuda9.0_arm64.deb \
	libcudnn7-doc_7.1.5.14-1+cuda9.0_arm64.deb \
	libopencv_3.3.1_t186_arm64.deb \
	libopencv-dev_3.3.1_t186_arm64.deb \
	libopencv-samples_3.3.1_t186_arm64.deb \
	libopencv-python_3.3.1_t186_arm64.deb \
	libgie-dev_4.1.3-1+cuda9.0_arm64.deb \
	libnvinfer-dev_4.1.3-1+cuda9.0_arm64.deb \
	libnvinfer-samples_4.1.3-1+cuda9.0_arm64.deb \
	libnvinfer4_4.1.3-1+cuda9.0_arm64.deb \
	libvisionworks-repo_1.6.0.500n_arm64.deb \
	libvisionworks-sfm-repo_0.90.3_arm64.deb \
	libvisionworks-tracking-repo_0.88.1_arm64.deb \
	tensorrt_4.0.2.0-1+cuda9.0_arm64.deb \
	; \
	do URL=${JETPACK_URL}/${DEB}; \
		curl -sSL ${URL} -o ${DEB}; \
	done

## Clean up (don't remove cuda libs... used by child containers)
RUN apt-get -y autoremove && apt-get -y autoclean
RUN rm -rf /var/cache/apt

###
### CUDA
###

FROM jetsontx2-jetpack33 as jetsontx2-cuda9

# install cuda-repo and cudnn
RUN for DEB in \
	cuda-repo-l4t-9-0-local_9.0.252-1_arm64.deb \
	libcudnn7_7.1.5.14-1+cuda9.0_arm64.deb \
	libcudnn7-dev_7.1.5.14-1+cuda9.0_arm64.deb \
	; do dpkg --install ${DEB}; done

# add GPG key from cuda-repo
RUN apt-key add /var/cuda-repo-9-0-local/7fa2af80.pub

# install cuda-toolkit
RUN apt-get update && apt-get install -y --allow-unauthenticated \
	cuda-toolkit-9.0

## Re-link libs in /usr/lib/<arch>/tegra
RUN ln -sf /usr/lib/aarch64-linux-gnu/tegra/libGL.so /usr/lib/aarch64-linux-gnu/libGL.so
RUN ln -sf /usr/lib/aarch64-linux-gnu/libcuda.so /usr/lib/aarch64-linux-gnu/libcuda.so.1

# add to link library path
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib/aarch64-linux-gnu/tegra

## Clean up (don't remove cuda libs... used by child containers)
RUN apt-get -y autoremove && apt-get -y autoclean
RUN rm -rf /var/cache/apt

###
### DARKNET
###

FROM jetsontx2-cuda9 as jetsontx2-darknet

RUN DEBIAN_FRONTEND=noninteractive && apt install -y git

# configure darknet
ARG DARKNET=/darknet
ARG DARKNET_GIT="http://github.com/pjreddie/darknet"
ENV DARKNET=${DARKNET} DARKNET_GIT=${DARKNET_GIT}
ENV DARKNET_TINY_WEIGHTS="${DARKNET}/yolov2-tiny-voc.weights"
ENV DARKNET_TINY_WEIGHTS_URL="http://pjreddie.com/media/files/yolov2-tiny-voc.weights"
ENV DARKNET_V2_WEIGHTS="${DARKNET}/yolov2.weights"
ENV DARKNET_V2_WEIGHTS_URL="https://pjreddie.com/media/files/yolov2.weights"
ENV DARKNET_V3_WEIGHTS="${DARKNET}/yolov3.weights"
ENV DARKNET_V3_WEIGHTS_URL="https://pjreddie.com/media/files/yolov3.weights"

# Clone darknet
RUN mkdir -p ${DARKNET} 
RUN cd ${DARKNET} && git clone ${DARKNET_GIT} .

# Build darknet
RUN \
    cd ${DARKNET} \
    \
    && PATH=/usr/local/cuda/bin:$PATH \
    \
    && LD_LIBRARY_PATH=/usr/local/cuda/lib:$LD_LIBRARY_PATH && ldconfig \
    \
    && make -j 4 GPU=1 CUDNN=1 OPENCV=0 OPENMP=0 DEBUG=0

## Clean up (don't remove cuda libs... used by child containers)
RUN apt-get -y autoremove && apt-get -y autoclean
RUN rm -rf /var/cache/apt

###
### CAFFE
###

FROM jetsontx2-cuda9 as jetsontx2-caffe

RUN apt-get update && apt-get install -y --no-install-recommends --allow-unauthenticated \
	build-essential \
	cmake \
	git \
	gfortran \
	libatlas-base-dev \
	libboost-all-dev \
	libgflags-dev \
	libfreetype6-dev \
	libpng12-dev \
	libgoogle-glog-dev \
	libhdf5-serial-dev \
	libleveldb-dev \
	liblmdb-dev \
	libprotobuf-dev \
	libsnappy-dev \
	protobuf-compiler \
	python-all-dev \
	python-dev \
	python-pip \
	libfreetype6-dev \
	pkg-config

# Pip for python stuff
RUN pip install --upgrade --no-cache-dir pip setuptools wheel
RUN pip install --no-cache-dir numpy
RUN pip install --no-cache-dir pillow matplotlib h5py protobuf scipy scikit-image scikit-learn

WORKDIR /
RUN git clone https://github.com/BVLC/caffe
WORKDIR /caffe
RUN apt-get install -y python-setuptools
WORKDIR /caffe/python
RUN for req in $(cat requirements.txt); do pip install --no-cache-dir $req; done
WORKDIR /caffe
RUN cp Makefile.config.example Makefile.config

# Prep make with correct Python include dirs
RUN sed -i "s/INCLUDE_DIRS := \$(PYTHON_INCLUDE) \/usr\/local\/include/INCLUDE_DIRS := \$(PYTHON_INCLUDE) \/usr\/local\/include \/usr\/local\/lib\/python2.7\/dist-packages\/numpy\/core\/include \/usr\/include\/hdf5\/serial/g" Makefile.config
RUN sed -i "s/# USE_CUDNN := 1/USE_CUDNN := 1/g" Makefile.config

# CUDA9.0 update: Comment out "compute_20" lines in makefile.config (this arch obsolete)
RUN sed -i "s/-gencode arch=compute_20,code=sm_20/#-gencode arch=compute_20,code=sm_20/g" Makefile.config
RUN sed -i "s/LIBRARIES += glog gflags protobuf boost_system boost_filesystem m hdf5_hl hdf5/LIBRARIES += glog gflags protobuf boost_system boost_filesystem m hdf5_serial_hl hdf5_serial opencv_core opencv_highgui opencv_imgproc opencv_imgcodecs/g" Makefile

# Build
RUN ldconfig
RUN make all -j4
RUN make pycaffe -j4
RUN make test -j4
RUN make distribute

# Clean up
RUN apt-get -y autoremove && apt-get -y autoclean
RUN rm -rf /var/cache/apt

###
### OPENCV
###

FROM jetsontx2-cuda9 as jetsontx2-opencv

RUN apt-get update && apt-get install -y \
	pkg-config

RUN apt-get update && apt-get install -y \
	libavcodec-ffmpeg56 \
	libavcodec-ffmpeg-extra56 \
	libavformat-ffmpeg56 \
	libswscale-ffmpeg3 \
	libtbb2 \
	libcairo2 \
	libgdk-pixbuf2.0-0 \
	libglib2.0-0 \
	libgtk2.0-0 \
	libjasper1 \
	libjpeg8 \
	libtbb-dev


RUN for DEB in \
	libopencv_3.3.1_t186_arm64.deb \
	libopencv-dev_3.3.1_t186_arm64.deb \
	libopencv-samples_3.3.1_t186_arm64.deb \
	libopencv-python_3.3.1_t186_arm64.deb \
	; do dpkg --install ${DEB}; done

## Clean up 
RUN apt-get -y autoremove && apt-get -y autoclean
RUN rm -rf /var/cache/apt


###
### MORE
###

RUN apt-get update && apt-get install -y --allow-unauthenticated \
	freeglut3-dev \
	libx11-dev \
	x11proto-dev \
	libxext-dev \ 
	libxfixes-dev \
	libxmu-dev \
	libglu1-mesa-dev \
	cuda-documentation-9-0 \
	cuda-samples-9-0 \
	libxi6 \
	libxi-dev \
	x11proto-input-dev \
	x11proto-core-dev

RUN apt-get update && apt-get install -y --allow-unauthenticated \
	libgl1-mesa-dev \
	libgl-dev 

