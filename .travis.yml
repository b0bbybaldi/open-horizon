## set notifications
notifications:
  slack:
    secure: cI0ItIgiIlcCx8Qec+BbV6t0yWHY7XgK2UEmYDNyZJhvW1lfBAANyZsgEu4JOgVTmqfENypltXjCczL5u0n6kRQx+WAMyrsPB4PHOt/mMB6yIyIjZRopPi18nfnIfxaZZSizLCGRstGIk6OhTrV06udTk7jwhQjZokj7LWZdY45mIgWtrT1Igu9yP9gHkFveEpi4UjI0DcWstNAJw55jhrC9gkfeeO9BeDoBs/Uyd87mtblD9sT5uWRz88d80fwRIQoaNR+M/41TJWRrNGqgmwf5yq/pXlGU34w/OM8OL1QxURC38ZMAtuH1QDFtwKCtTmfdEpeDjcdXqqeQWkq0DLh/0vFXtuYgb9/1GTYfpTl++Fp6PKOkENWln7S3SjnvE2YcDiMUu4kdtKAv6KZexclmmvUTqQh+NySvFR4H9lA/tBJDSGT2tNABvPq84TZY8E8HCL4IcMgncZ7uWPX7r1w1CD954mIQEzyS2U/USRjjd0O4/JYHDMUayMU1Z+iB1HRvS6Xw8gVwUm0GNpxm60YBI32XW+oKVV6viAJ9kptxFaogv18sqkfyhSMkmrsVRoLhnhW929+jIZVktvGYLcbfYK4bksmD7TMF2XTY7ZrFNm6spS2rec53mfmneqtkCiI8vRH7ntmCuFmkbv+fS4MviSLxIRPXWbrXwPHp/Os=
  email:
    recipients:
    - dcmartin@us.ibm.com
    on_success: change
    on_failure: always
## this is going to take sudo powers
sudo: true

## and it's done using bash
language: bash

## it needs docker
services: 
  - docker

## and use xenial; open horizon package is xenial for production; bionic only for LA
dist: xenial

## branches on which we act
branches:
  only:
    - master
    - beta

## stages
stages:
  - name: beta-pull-request
    if: branch = beta AND type = pull-request
  - name: beta-publish
    if: branch = beta AND type != pull-request
#    env: TAG=beta DEBUG=true BUILD_ON=false TEST_ON=true # PUSH_ON=false PUBLISH_ON=false PATTERN_ON=true
  - name: beta-deploy
    if: branch = master AND type != pull-request
#    env: TAG=beta DEBUG=true BUILD_ON=false TEST_ON=true # PUSH_ON=false PUBLISH_ON=false PATTERN_ON=true
  - name: master-pull-request
    if: branch = master AND type = pull-request
  - name: master-publish
    if: branch = master AND type != pull-request
  - name: master-deploy
    if: branch = master AND type != pull-request
#env: 
#  - BUILD_ARCH=amd64 DEBUG=true BUILD_ON=false TEST_ON=true # PUSH_ON=false PUBLISH_ON=false PATTERN_ON=true
#  - BUILD_ARCH=arm64 EXP=true QEMU=true DEBUG=true BUILD_ON=false TEST_ON=false # PUSH_ON=false PUBLISH_ON=false PATTERN_ON=true
#  - BUILD_ARCH=arm   EXP=true QEMU=true DEBUG=true BUILD_ON=false TEST_ON=false # PUSH_ON=false PUBLISH_ON=false PATTERN_ON=true
jobs:
  include:
    # beta pull-request
    stage: beta-pull-request
    # env: TAG=beta DEBUG=true BUILD_ON=false TEST_ON=true # PUSH_ON=false PUBLISH_ON=false PATTERN_ON=true
    script:
      - ./.travis/travis-pull-request.sh beta
      - if [ ${TEST_ON:-false} = true ]; then make build-service test-service; fi
      #- if [ ${TEST_ON:-false} = true ]; then for A in amd64 arm64 arm; do make BUILD_ARCH=${A} TAG=beta build-service test-service; done; fi
    # beta publish
    stage: beta-publish
    script:
      - ./.travis/travis-publish.sh beta
      - if [ ${PUBLISH_ON:-false} = true ]; then for A in amd64 arm64 arm; do make BUILD_ARCH=${A} TAG=beta build-service test-service publish-service; done; fi
    # beta deploy
    stage: beta-deploy
    script:
      - ./.travis/travis-deploy.sh beta
      - if [ ${PATTERN_ON:-false} = true ]; then make TAG=beta pattern-publish; fi
    # master pull-request
    stage: master-pull-request
    script:
      - ./.travis/travis-pull-request.sh
      - if [ ${TEST_ON:-false} = true ]; then make build-service test-service; fi
    # master publish
    stage: master-publish
    script:
      - ./.travis/travis-publish.sh
      - if [ ${PUBLISH_ON:-false} = true ]; then make build-service test-service publish-service; fi
    # master deploy
    stage: master-deploy
    script:
      - ./.travis/travis-deploy.sh
      - if [ ${PATTERN_ON:-false} = true ]; then make pattern-publish; fi

## addons required to act
addons:
  apt:
    update: true
    sources:
    - sourceline: deb [arch=amd64,armhf,arm64,ppc64el] http://pkg.bluehorizon.network/linux/ubuntu xenial-updates main
      key_url: "http://pkg.bluehorizon.network/bluehorizon.network-public.key"
    packages:
    - make
    - git-flow
    - curl
    - gettext
    - jq
    - ca-certificates
    - gnupg
    - bluehorizon
    - docker-ce
    - qemu
    - qemu-user
    - qemu-user-static
    - binfmt-support
    - dpkg-cross

## before installing or doing anything else, do these things:
before_install:
  # create files from secrets (not for pulls)
  - if [ ${TRAVIS_BEFORE:=true} = true ]; then ./.travis/travis-before-install.sh; fi
  # enable experimental features in Docker
  - if [ ${EXP} = true ]; then ./.travis/docker-enable-experimental.sh; fi
  # enable QEMU emulation
  - if [ ${QEMU} = true ]; then ./.travis/docker-enable-qemu.sh; fi

## after installing, but BEFORE acting, do these things:
before_script:

## PERFORM THE ACT
script:
  # anything or nothing at all
  - if [ ${TRAVIS_SCRIPT:-false} = true ]; then ./.travis/travis-script.sh; fi
  # check all services
  - if [ ${CHECK_ON:-false} = true ]; then make; fi
  # do the build
  - if [ ${BUILD_ON:-false} = true ]; then make build-service; fi
  # do the test
  - if [ ${TEST_ON:-false} = true ]; then make build-service test-service; fi

## after successful performance, accept accolades and do the following:
after_success:
  # anything or nothing at all
  - if [ ${TRAVIS_SUCCESS:-false} = true ]; then ./.travis/travis-after-success.sh; fi

## after failure; at least clean-up
after_failure:
  - if [ ${TRAVIS_FAILURE:-false} = true ]; then ./.travis/travis-after-failure.sh; fi

## after the script (if anything)
after_script:
  - if [ ${TRAVIS_AFTER:-false} = true ]; then ./.travis/travis-after-script.sh; fi

#
#before_deploy:
#  - if [ ${DEPLOY_ON:-false} = true ]; then make nodes-clean && make nodes-list; fi
#
#deploy:
#  provider: script
#  script:
#    - if [ ${PATTERN_ON:-false} = true ]; then make pattern-publish; fi
#    - if [ ${DEPLOY_ON:-false} = true ]; then ./.travis/travis-deploy-nodes.sh; fi
#  on:
#    branch: master
#
#  provider: script
#  script:
#    # update master on git
#    - if [ ${GIT_PUSH:-false} = true ]; then ./.travis/git-push.sh; fi
#  on:
#    branch: beta
#
##after_deploy:
##  - if [ ${DEPLOY_ON:-false} = true ]; then make nodes && make nodes-list && make nodes-test; fi
